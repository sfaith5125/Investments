{% extends "base.html" %}

{% block title %}Articles - Tech Investment Crawler{% endblock %}

{% block content %}
<div class="articles-page">
    <h1>All Articles</h1>
    
    <div class="filters">
        <label for="source-filter">Filter by source:</label>
        <select id="source-filter" class="filter-select">
            <option value="">All Sources</option>
            {% for source in sources %}
            <option value="{{ source }}">{{ source }}</option>
            {% endfor %}
        </select>
        
        <label for="days-filter">Last:</label>
        <select id="days-filter" class="filter-select">
            <option value="7">7 days</option>
            <option value="30" selected>30 days</option>
            <option value="90">90 days</option>
            <option value="365">1 year</option>
        </select>
    </div>

    <div id="articles-container" class="articles-list">
        <p class="loading">Loading articles...</p>
    </div>

    <div id="pagination" class="pagination"></div>
</div>

<script>
    let currentPage = 1;
    const articlesPerPage = 20;

    async function loadArticles() {
        const source = document.getElementById('source-filter').value;
        const days = document.getElementById('days-filter').value;
        
        try {
            const url = new URL('/api/articles', window.location.origin);
            url.searchParams.append('limit', articlesPerPage);
            url.searchParams.append('days', days);
            if (source) url.searchParams.append('source', source);
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.success) {
                renderArticles(data.articles);
            } else {
                document.getElementById('articles-container').innerHTML = 
                    '<p class="error">Error loading articles: ' + data.error + '</p>';
            }
        } catch (error) {
            document.getElementById('articles-container').innerHTML = 
                '<p class="error">Error loading articles: ' + error.message + '</p>';
        }
    }

    function renderArticles(articles) {
        const container = document.getElementById('articles-container');
        
        if (articles.length === 0) {
            container.innerHTML = '<p class="no-results">No articles found.</p>';
            return;
        }
        
        container.innerHTML = articles.map(article => {
            const summaryText = article.summary ? article.summary.trim() : 'No summary available';
            const truncatedSummary = summaryText.length > 300 ? `${summaryText.substring(0, 300)}…` : summaryText;
            const contentText = (article.content && article.content.trim()) || summaryText;
            const contentHtml = formatContentHtml(contentText);

            return `
            <div class="article-card">
                <div class="article-header">
                    <h3><a href="/article/${article.id}">${article.title}</a></h3>
                    <span class="source-badge">${article.source}</span>
                </div>
                <p class="article-summary">${truncatedSummary}</p>
                <div class="article-footer">
                    <span class="article-date">${new Date(article.published_date).toLocaleDateString()}</span>
                    ${article.tags.length > 0 ? `
                        <div class="article-tags">
                            ${article.tags.map(tag => `<span class="tag">${tag.trim()}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
                <div class="article-slide" id="article-slide-${article.id}" aria-hidden="true">
                    ${contentHtml}
                </div>
                <div class="article-actions">
                    <button class="btn btn-secondary slide-toggle" data-target="article-slide-${article.id}" aria-expanded="false" aria-controls="article-slide-${article.id}">
                        Show Full Article
                    </button>
                    <a href="/article/${article.id}" class="btn btn-secondary">View in App</a>
                    <a href="${article.url}" class="btn btn-link" target="_blank" rel="noopener noreferrer">Original Source ↗</a>
                </div>
            </div>
            `;
        }).join('');
    }

    document.getElementById('source-filter').addEventListener('change', loadArticles);
    document.getElementById('days-filter').addEventListener('change', loadArticles);

    loadArticles();
</script>
{% endblock %}
